#!/usr/bin/env bash
# penv - virtual environment manager

set -euo pipefail
IFS=$'\n\t'

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="$SCRIPT_DIR/lib"

CLIENT_VERSION="2.0"

# Source configurations
if [ -f "$SCRIPT_DIR/config.sh" ]; then
  source "$SCRIPT_DIR/config.sh"
fi

# Source all library modules
source "$LIB_DIR/config.sh"
source "$LIB_DIR/utils.sh"
source "$LIB_DIR/index.sh"
source "$LIB_DIR/distro.sh"
source "$LIB_DIR/env.sh"
source "$LIB_DIR/commands.sh"

# Add BIN_DIR to PATH
export PATH="$BIN_DIR:$PATH"

# -------- Main dispatch --------
if (( $# < 1 )); then
  cmd::usage
  exit 0
fi

command="$1"
shift

case "$command" in
  version|--version)
    cmd::version
    ;;
  init)
    cmd::init
    ;;
  # Get/download distro
  get|download|dl)
    cmd::get "$@"
    ;;
  # Import rootfs tarball
  import)
    cmd::import "$@"
    ;;
  # Modify distro with addons
  mod|modify)
    cmd::mod "$@"
    ;;
  # Create environment
  create|new)
    cmd::create "$@"
    ;;
  # Enter environment (shell)
  shell|enter|sh)
    cmd::shell "$@"
    ;;
  # Delete/remove
  delete|remove|rm)
    cmd::rm "$@"
    ;;
  # List resources
  list|ls)
    cmd::list "$@"
    ;;
  # Help
  help|--help|-h)
    cmd::usage
    ;;
  *)
    err "Unknown command: $command"
    cmd::usage
    exit 2
    ;;
esac
