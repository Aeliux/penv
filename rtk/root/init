#!/bin/sh

# init script to be run in the initial ramdisk environment

echo "Welcome to Rootbox Tiny Kernel on $(uname -sr)"
echo "Invoked as: $0 $*"

PREFERRED_TTY="/dev/ttyS0"

# Parse arguments
for arg in "$@"; do
  case $arg in
    --tty:*)
      PREFERRED_TTY="${arg#--tty:}"
      ;;
  esac
done

if ! mountpoint -q /dev 2>/dev/null; then
  mkdir -p /dev
  mount -t devtmpfs devtmpfs /dev || true
fi

mount -t proc proc /proc || true
mount -t sysfs sysfs /sys || true

echo "Mounting root filesystem from host..."

# create target mount point
mkdir -p /mnt/host

# Mount the host export (mount_tag=host0 in QEMU args)
# trans=virtio is required for virtio transport; use version=9p2000.L for modern qemu
mount -t 9p -o trans=virtio,version=9p2000.L host0 /mnt/host || {
  echo "Failed to mount host 9p share; dropping to shell"
  exec /bin/sh
}

echo "Preparing root filesystem switch..."

# Mount necessary filesystems
mkdir -p /mnt/host/dev
mount -t devtmpfs devtmpfs /mnt/host/dev || true

mkdir -p /mnt/host/proc
mount -t proc proc /mnt/host/proc || true

mkdir -p /mnt/host/sys
mount -t sysfs sysfs /mnt/host/sys || true

# mount all dev/* filesystems
mkdir -p /mnt/host/dev/pts
mount -t devpts devpts /mnt/host/dev/pts || true

mkdir -p /mnt/host/dev/shm
mount -t tmpfs tmpfs /mnt/host/dev/shm || true

mkdir -p /mnt/host/dev/mqueue
mount -t mqueue mqueue /mnt/host/dev/mqueue || true

mkdir -p /mnt/host/tmp
chmod 1777 /mnt/host/tmp
mount -t tmpfs tmpfs /mnt/host/tmp || true

# Copy busybox to host fs for late init use
cp /bin/busybox /mnt/host/tmp/busybox
cp -R /rtk /mnt/host/tmp/rtk

if [ -e /mnt/host/sbin/pinit_rtk ]; then
  INIT_CMD="/sbin/pinit_rtk"
fi

if [ -z "$INIT_CMD" ]; then
  INIT_CMD="/tmp/rtk/init_lately"
fi
exec /bin/sh
# Switch to host root filesystem
echo "Switching to host root filesystem..."
set -x
exec /sbin/switch_root /mnt/host "$INIT_CMD" -- --tty "$PREFERRED_TTY"
